<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G-Force Dashboard</title>

    <style>
        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: #0f172a;
            color: #e5e7eb;
        }

        header {
            padding: 1rem;
            text-align: center;
            background: #020617;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding: 1rem;
        }

        .card {
            background: #020617;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .value {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        canvas {
            width: 100%;
            height: 300px;
            display: block;
            background: #020617;
        }

        button {
            margin: 1rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            background: #2563eb;
            color: white;
        }

        .note {
            padding: 0 1rem 1rem;
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: center;
        }
    </style>
</head>

<body>

    <header>G-Force Dashboard (Schätzung)</header>

    <button id="start">Sensoren aktivieren</button>

    <div class="stats">
        <div class="card">
            Aktuell
            <div class="value" id="current">-</div>
        </div>
        <div class="card">
            Max
            <div class="value" id="max">-</div>
        </div>
        <div class="card">
            Min
            <div class="value" id="min">-</div>
        </div>
    </div>

    <canvas id="graph" width="800" height="300"></canvas>

    <div class="note">
        Geschätzte Gesamt-G basierend auf Smartphone-Beschleunigung inkl. Gravitation
    </div>

    <script>
        const G = 9.81;
        const MAX_SECONDS = 180; // letzte 3 Minuten
        const SAMPLE_RATE = 50; // ms (ca.)

        let values = [];
        let timestamps = [];

        let maxG = -Infinity;
        let minG = Infinity;

        const currentEl = document.getElementById("current");
        const maxEl = document.getElementById("max");
        const minEl = document.getElementById("min");

        const canvas = document.getElementById("graph");
        const ctx = canvas.getContext("2d");

        function drawGraph() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (values.length < 2) return;

            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);

            ctx.beginPath();
            ctx.strokeStyle = "#38bdf8";
            ctx.lineWidth = 2;

            values.forEach((v, i) => {
                const x = (i / (values.length - 1)) * canvas.width;
                const y = canvas.height - ((v - minVal) / (maxVal - minVal || 1)) * canvas.height;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();
        }

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const gx = acc.x || 0;
            const gy = acc.y || 0;
            const gz = acc.z || 0;

            const gTotal = Math.sqrt(gx * gx + gy * gy + gz * gz) / G;

            const now = Date.now();

            values.push(gTotal);
            timestamps.push(now);

            // Alte Werte entfernen
            while (timestamps[0] < now - MAX_SECONDS * 1000) {
                timestamps.shift();
                values.shift();
            }

            maxG = Math.max(maxG, gTotal);
            minG = Math.min(minG, gTotal);

            currentEl.textContent = gTotal.toFixed(2) + " g";
            maxEl.textContent = maxG.toFixed(2) + " g";
            minEl.textContent = minG.toFixed(2) + " g";

            drawGraph();
        }

        async function startSensors() {
            if (typeof DeviceMotionEvent !== "undefined" &&
                typeof DeviceMotionEvent.requestPermission === "function") {
                const permission = await DeviceMotionEvent.requestPermission();
                if (permission !== "granted") {
                    alert("Sensor-Zugriff verweigert");
                    return;
                }
            }

            window.addEventListener("devicemotion", handleMotion, { interval: SAMPLE_RATE });
        }

        document.getElementById("start").addEventListener("click", startSensors);
    </script>

</body>

</html>